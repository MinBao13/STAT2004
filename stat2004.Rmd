---
title: "Untitled"
output: html_document
date: '2025-10-17'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


# --- Impute Data ---

```{r}
library(dplyr)
library(randomForestSRC)
library(MASS)
library(GGally)
```

```{r}
Pollute <- readxl::read_excel("AirQualityUCI.xlsx")
```

```{r}
pollutants <- c(3:15)
Pollute[pollutants] <- lapply(Pollute[pollutants], function(x) na_if(x, -200))
```

```{r}
Pollute1 <- Pollute[3:15]
```

#Impute using random forest
```{r}
rf_imp <- rfsrc(data = Pollute1, nodesize = 1, nsplit = 10, nimpute = 2, na.action = "na.impute")
```

#Extract the imputed data
```{r}
ImputedPollute <- rf_imp$xvar
```

# --- Unit Conversion ---

```{r}
#Converters 
mgm3_CO <- function(C, temperature = 25, pressure = 1) {
  # C: concentration in mg/m³
  # temperature: °C (default 25°C)
  # pressure: atm (default 1 atm)
  
  mol_weight <- 28.01  # g/mol for CO
  T <- temperature + 273.15  # Convert to Kelvin
  
  # Conversion formula
  ppm <- (C * 24.45 * pressure) / (mol_weight * (T / 298))
  
  return(ppm)
}

microg_NO2 <- function(C, temperature = 25, pressure = 1) {
  # C: concentration in µg/m³
  # temperature: °C (default 25°C)
  # pressure: atm (default 1 atm)
  
  mol_weight <- 46.01  # g/mol for NO2
  T <- temperature + 273.15  # convert to Kelvin
  
  # Convert µg/m³ to mg/m³ first
  mg_m3 <- C / 1000
  
  # Conversion formula:
  # ppm = (mg/m³ * 24.45 * (P / 1 atm)) / (MW * (T / 298 K))
  ppm <- (mg_m3 * 24.45 * pressure) / (mol_weight * (T / 298))
  
  # Convert ppm → ppb
  ppb <- ppm * 1000
  
  return(ppb)
}
```

```{r}
# Apply conversion to dataset
ConvertedPollute <- ImputedPollute %>%
  mutate(
    `CO(GT)` = mgm3_CO(`CO(GT)`),       # Convert CO from mg/m³ to ppm
    `NO2(GT)` = microg_NO2(`NO2(GT)`)   # Convert NO2 from µg/m³ to ppb
  )
```

# --- Calculate AQI ---

```{r}
# AQI calculator returning both AQI value and category
AQI <- function(P){
  # Extract pollutant vectors
  CO  <- P$CO
  NO2 <- P$NO2 

  # --- Breakpoint tables ---
  CO_bp <- data.frame(
    c_lo = c(0.0, 4.5,  9.5, 12.5, 15.5, 30.5, 40.5),
    c_hi = c(4.4, 9.4, 12.4, 15.4, 30.4, 40.4, 50.4),
    i_lo = c(  0,  51, 101, 151, 201, 301, 401),
    i_hi = c( 50, 100, 150, 200, 300, 400, 500)
  )

  NO2_bp <- data.frame(
    c_lo = c(   0,   54,  101,  361,   650,  1250,  1650),
    c_hi = c(  53,  100,  360,  649,  1249,  1649,  2049),
    i_lo = c(   0,   51,  101,  151,   201,   301,   401),
    i_hi = c(  50,  100,  150,  200,   300,   400,   500)
  )

  # --- Helper: subindex interpolation ---
  calc_subindex <- function(C, bp) {
    sapply(C, function(cval) {
      r <- which(cval >= bp$c_lo & cval <= bp$c_hi)[1]
      with(bp[r, ], (i_hi - i_lo) / (c_hi - c_lo) * (cval - c_lo) + i_lo)
    })
  }

  # --- Compute subindices and overall AQI ---
  aqi_co  <- calc_subindex(CO,  CO_bp)
  aqi_no2 <- calc_subindex(NO2, NO2_bp)
  max_aqi <- pmax(aqi_co, aqi_no2)

  # --- AQI categories ---
  category <- cut(
    max_aqi,
    breaks = c(-Inf, 50, 100, 150, 200, 300, 400, Inf),
    labels = c("Good", "Moderate", "Unhealthy (Sensitive)",
               "Unhealthy", "Very Unhealthy", "Hazardous", "Extremely Hazardous"),
    right = TRUE
  )

  # --- Return both AQI and category ---
  data.frame(
    AQI = round(max_aqi, 2),
    Category = category
  )
}

df <- data.frame(CO = ConvertedPollute$`CO(GT)`, NO2 = ConvertedPollute$`NO2(GT)`)  

AQI_results <- AQI(df)
ConvertedPollute$AQI <- AQI_results$AQI
ConvertedPollute$AQI_level <- AQI_results$Category
```


```{r, fig.width=30, fig.height=20}
ggpairs(ConvertedPollute[c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)","NO2(GT)","T", "RH", "AH", "AQI","AQI_level")], aes(colour = AQI_level, alpha = 0.4) )
ggpairs(ConvertedPollute[c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)","T", "RH", "AH", "AQI","AQI_level")], aes(colour = AQI_level, alpha = 0.4) )
```

```{r}
rf_imp <- rfsrc(data = ConvertedPollute, nodesize = 1, nsplit = 10, nimpute = 2, na.action = "na.impute")
ConvertedPollute <- rf_imp$xvar
```

#PCA ANALYSIS

```{r}
ScaledPollute <- as.data.frame(scale(ConvertedPollute[1:14]))
ScaledPollute$AQI_level <- AQI_results$Category
```

```{r}
pca_result <- prcomp(ScaledPollute[1:10], center = TRUE, )
summary(pca_result)
loadings <- pca_result$rotation
print(loadings)
```

```{r}
plot(pca_result, type = "l", main = "Scree Plot")
biplot(pca_result, scale = 0)
```

```{r}
pca_data <- as.data.frame(pca_result$x[, 1:2])  # Keep PC1 and PC2
pca_rf_data <- cbind(pca_data, AQI = ConvertedPollute$AQI)

# --- PART 3: RANDOM FOREST MODEL  ---

# 3. Data Split (Training and Testing Sets)
set.seed(42) # For reproducibility
train_index <- sample(1:nrow(pca_rf_data), size = 0.8 * nrow(pca_rf_data)) # 80% for training
train_data <- pca_rf_data[train_index, ]
test_data <- pca_rf_data[-train_index, ]
PCADataTrain <- (train_data[1:3])
PCADataTest <- (test_data[1:3])

# Train the model using rfsrc
rf_pca <- rfsrc(
  AQI ~ . , 
  data = PCADataTrain, 
  ntree = 100,
  importance = "none",
  seed = 42
)

print(rf_pca)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_pca, newdata = PCADataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(PCADataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_pca$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = PCADataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```


```{r}
rf_model_diag <- rfsrc(AQI ~ ., data = ConvertedPollute[1:14], ntree = 100, importance = 'none', seed = 42)
interaction.diag <- find.interaction.rfsrc(rf_model_diag, seed = 42)
```

```{r}
head(interaction.diag)
```
 
```{r}
plot.variable.rfsrc(rf_model_diag, xvar.names = c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)","NO2(GT)"))
plot.variable.rfsrc(rf_model_diag, xvar.names = c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)"))
plot.variable.rfsrc(rf_model_diag, xvar.names = c("T", "RH", "AH"))
```

```{r}
# 3. Data Split (Training and Testing Sets)
set.seed(42) # For reproducibility
train_index <- sample(1:nrow(ConvertedPollute), size = 0.8 * nrow(ConvertedPollute)) # 80% for training
train_data <- ConvertedPollute[train_index, ]
test_data <- ConvertedPollute[-train_index, ]
```

```{r}
# --- PART 3: RANDOM FOREST MODEL  ---

AllDataTrain <- (train_data[1:14])
AllDataTest <- (test_data[1:14])

# Train the model using rfsrc
rf_model_all <- rfsrc(
  AQI ~ . , 
  data = AllDataTrain, 
  ntree = 500,
  importance = "none",
  seed = 42
)

print(rf_model_all)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_all, newdata = AllDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(AllDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_all$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = AllDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```

```{r}
#Model excluding Carbon Monoxide and Nitrogen Dioxide

OtherDataTrain <- train_data[-c(1,8,15)]
OtherDataTest <- test_data[-c(1,8,15)]

rf_model_other <- rfsrc(
  AQI ~ ., 
  data = OtherDataTrain, 
  ntree = 500,
  importance = "none",
  seed = 42
)

print(rf_model_other)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_other, newdata = OtherDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(OtherDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_other$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ (. - AQI_level - `CO(GT)` - `NO2(GT)`) ,
  data = OtherDataTrain,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)

```

```{r}
#Model excluding Nitrogen Oxides

##EDITING THIS 
xNODataTrain <- train_data[-c(6,8,15)]
xNODataTest <- test_data[-c(6,8,15)]

rf_model_xNO <- rfsrc(
  AQI ~ ., 
  data = xNODataTrain, 
  ntree = 500,
  importance = "none",
  seed = 42
)

print(rf_model_xNO)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_xNO, newdata = xNODataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(xNODataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_xNO$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = xNODataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```

```{r}
# --- PART 3: RANDOM FOREST MODEL  ---

#Pollutants

PollutantDataTrain <- train_data[c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)", "NO2(GT)", "AQI")]
PollutantDataTest <- test_data[c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)", "NO2(GT)", "AQI")]

# Train the model using rfsrc
rf_model_pol <- rfsrc(
  AQI ~ . , 
  data = PollutantDataTrain, 
  ntree = 500,
  importance = "none",
  mtry = 4,
  seed = 42
)

print(rf_model_pol)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_pol, newdata = PollutantDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(PollutantDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_pol$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = PollutantDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)

xNO2PollutantDataTrain <- train_data[c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)","AQI")]
xNO2PollutantDataTest <- test_data[c("CO(GT)","NMHC(GT)","C6H6(GT)","NOx(GT)","AQI")]

# Train the model using rfsrc
rf_model_pol_xNO2 <- rfsrc(
  AQI ~ . , 
  data = xNO2PollutantDataTrain, 
  ntree = 500,
  importance = "none",
  mtry = 4,
  seed = 42
)

print(rf_model_pol_xNO2)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_pol_xNO2, newdata = xNO2PollutantDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(xNO2PollutantDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_pol_xNO2$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = xNO2PollutantDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```

```{r}
#Sensor Model

SensorDataTrain <- train_data[c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)", "AQI")]
SensorDataTest <- test_data[c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)", "AQI")]

# Train the model using rfsrc
rf_model_sensor <- rfsrc(
  AQI ~ . , 
  data = SensorDataTrain, 
  ntree = 500,
  importance = "none",
  mtry = 4,
  seed = 42
)

print(rf_model_sensor)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_sensor, newdata = SensorDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(SensorDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_sensor$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = SensorDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```

```{r}
#General Air Characteristics (T, RH, AH)

TempDataTrain <- train_data[c("T", "RH", "AH", "AQI")]
TempDataTest <- test_data[c("T", "RH", "AH", "AQI")]

# Train the model using rfsrc
rf_model_temp <- rfsrc(
  AQI ~ . , 
  data = TempDataTrain, 
  ntree = 500,
  importance = "none",
  mtry = 4,
  seed = 42
)

print(rf_model_temp)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_temp, newdata = TempDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(TempDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_temp$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = TempDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)

# General Air Characteristics (T, RH, AH) Testing to see the effects of adding sensor data

TempSDataTrain <- train_data[c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)","T", "RH", "AH", "AQI")]
TempSDataTest <- test_data[c("PT08.S2(NMHC)","PT08.S1(CO)", "PT08.S5(O3)", "PT08.S3(NOx)","PT08.S4(NO2)","T", "RH", "AH", "AQI")]

# Train the model using rfsrc
rf_model_temp_sensor <- rfsrc(
  AQI ~ . , 
  data = TempSDataTrain, 
  ntree = 500,
  importance = "none",
  mtry = 4,
  seed = 42
)

print(rf_model_temp_sensor)

# --- PART 4: MODEL EVALUATION ---

## ---- Evaluate the trained regression model on the test set ----
pred_obj <- predict(rf_model_temp_sensor, newdata = TempSDataTest)
y_hat    <- as.numeric(pred_obj$predicted)
y_true   <- as.numeric(TempSDataTest$AQI)

RMSE <- sqrt(mean((y_hat - y_true)^2))
MAE  <- mean(abs(y_hat - y_true))
R2_holdout <- 1 - sum((y_hat - y_true)^2) / sum( (y_true - mean(y_true))^2 )

cat(sprintf("\nHoldout metrics\nRMSE: %.3f\nMAE : %.3f\nR²  : %.3f\n",
            RMSE, MAE, R2_holdout))

## OOB R² from the trained model (last tree aggregated)
R2_oob <- tail(rf_model_temp_sensor$rsq, 1)
cat(sprintf("OOB R² (training): %.3f\n", R2_oob))

## Optional: quick residual diagnostics
resid <- y_true - y_hat
cat(sprintf("Residual mean: %.3f | SD: %.3f\n", mean(resid), sd(resid)))

# If you want a quick glance table:
head(data.frame(AQI_true = y_true, AQI_pred = round(y_hat,1), Residual = round(resid,1)))

rf_model_imp <- rfsrc(
  AQI ~ . ,
  data = TempSDataTest,
  ntree = 500,
  na.action = "na.impute",
  importance = TRUE,
  seed = 42
)
sort(rf_model_imp$importance, decreasing = TRUE)[1:10]
barplot(rf_model_imp$importance,
        main = "Variable Importance ",
        col = "skyblue",
        las = 2,
        cex.names = 0.7)
```

```{r}

#IGNORE THIS CHUNK FOR NOW

# helper to bucket numeric AQI into EPA categories
bucket_aqi <- function(x){
  cut(x,
      breaks = c(-Inf, 50, 100, 150, 200, 300, 400, Inf),
      labels = c("Good","Moderate","Unhealthy (Sensitive)",
                 "Unhealthy","Very Unhealthy","Hazardous","Extremely Hazardous"),
      right = TRUE)
}

pred_level <- bucket_aqi(y_hat)
true_level <- test_data$AQI_level

cm <- table(Truth = true_level, Pred = pred_level)
acc <- sum(diag(cm)) / sum(cm)
cm
cat(sprintf("\nCategorical accuracy after bucketing: %.3f\n", acc))
```

```{r}
# --- Helpers ---
bucket_aqi <- function(x){
  cut(x,
      breaks = c(-Inf, 50, 100, 150, 200, 300, 400, Inf),
      labels = c("Good","Moderate","Unhealthy (Sensitive)",
                 "Unhealthy","Very Unhealthy","Hazardous","Extremely Hazardous"),
      right = TRUE)
}

confmat_rf <- function(model, newdata, target = "AQI", truth_levels_col = "AQI_level"){
  pred <- predict(model, newdata = newdata)$predicted
  pred_level <- bucket_aqi(as.numeric(pred))

  true_level <- if (truth_levels_col %in% names(newdata)) {
    newdata[[truth_levels_col]]
  } else {
    bucket_aqi(as.numeric(newdata[[target]]))
  }

  pred_level <- factor(pred_level, levels = levels(bucket_aqi(0)))
  true_level <- factor(true_level, levels = levels(bucket_aqi(0)))

  table(Truth = true_level, Pred = pred_level)
}

# --- Confusion matrices for each of your models/datasets ---
cat("\n===== PCA Model Confusion Matrix =====\n")
cm_pca <- confmat_rf(rf_pca, PCADataTest)
print(cm_pca)

cat("\n===== All Variables Model Confusion Matrix =====\n")
cm_all <- confmat_rf(rf_model_all, AllDataTest)
print(cm_all)

cat("\n===== Excluding CO & NO2 Model Confusion Matrix =====\n")
cm_other <- confmat_rf(rf_model_other, OtherDataTest)
print(cm_other)

cat("\n===== Excluding NOx & NO2 Model Confusion Matrix =====\n")
cm_xno <- confmat_rf(rf_model_xNO, xNODataTest)
print(cm_xno)

cat("\n===== Pollutant Model Confusion Matrix =====\n")
cm_pollutant <- confmat_rf(rf_model_pol, PollutantDataTest)
print(cm_pollutant)

cat("\n===== Pollutant Model Excluding NO2 Confusion Matrix =====\n")
cm_pollutant_xNO2 <- confmat_rf(rf_model_pol_xNO2, xNO2PollutantDataTest)
print(cm_pollutant_xNO2)

cat("\n===== Sensor Model Confusion Matrix =====\n")
cm_sensor <- confmat_rf(rf_model_sensor, SensorDataTest)
print(cm_sensor)

cat("\n===== Temperature / RH / AH Model Confusion Matrix =====\n")
cm_temp <- confmat_rf(rf_model_temp, TempDataTest)
print(cm_temp)

cat("\n===== Temperature + Sensor Confusion Matrix =====\n")
cm_temp_sensor <- confmat_rf(rf_model_temp_sensor, TempSDataTest)
print(cm_temp_sensor)
```
